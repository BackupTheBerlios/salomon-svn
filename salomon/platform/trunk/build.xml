<project name="salomon" default="all" basedir=".">

	<!-- Allows us to use the IzPack Ant task -->
	<taskdef name="izpack" classpath="${basedir}/lib/compiler.jar"
		classname="com.izforge.izpack.ant.IzPackTask"/>
	<taskdef name="svn" 
		classpath="${basedir}/lib/svn/svnant.jar;${basedir}/lib/svn/svnClientAdapter.jar;${basedir}/lib/svn/svnjavahl.jar"
			classname="org.tigris.subversion.svnant.SvnTask" />
		<!--	resource="svntask.properties"/> -->
	
	<property name="src_dir" value="src"/>

	
	<property name="bin_dir" value="bin"/>
	<property name="lib_dir" value="lib"/>	
	<property name="res_dir" value="res"/>
	<property name="plugin_dir" value="plugins"/>
	<property name="db_dir" value="db"/>
	<property name="db_file" value="salomon.gdb"/>	
	<property name="crebas_file" value="crebas.sql"/>	
	<property name="run_script" value="run.bat"/>	
	
	<property name="release_dir" value="_release" />

	<target name="compile_salomon" >
		<echo message="Build salomon core"/>
		<javac srcdir="${src_dir}/" 
		       includes="salomon/**"
		classpath="${lib_dir}/log4j-1.2.8.jar"		
		       destdir="${bin_dir}" />
	</target>
	
	<target name="build_averageprice_jar" >
		<jar destfile="${plugin_dir}/AveragePrice.jar" basedir="${bin_dir}"	   
			includes="pl/**/averageprice/**">	
			<manifest>				
			<attribute name="Main-Class" value="pl.edu.agh.icsr.salomon.plugin.averageprice.AveragePrice"/>      	
		</manifest>
		</jar>		
		
	</target>

	<target name="build_simpleconsole_jar" >
		<jar destfile="${plugin_dir}/SimpleSQLConsole.jar" basedir="${bin_dir}"	   
			includes="pl/**/simpleconsole/**">	
			<manifest>				
			<attribute name="Main-Class" value="pl.edu.agh.icsr.salomon.plugin.simpleconsole.SimpleSQLConsole"/>      	
		</manifest>
		</jar>		
		
	</target>

	<target name="init">
		<mkdir dir="${bin_dir}"/>
	</target>

	<target name="build_salomon_jar" depends="build_rmi_stubs">
		<jar destfile="salomon.jar"	basedir="${bin_dir}"   			
			includes="salomon/**">	
			<manifest>				
			<attribute name="Main-Class" value="salomon.Starter"/>      	
			<attribute name="Class-Path" value="${lib_dir}/firebirdsql.jar ${lib_dir}/log4j-1.2.8.jar ${lib_dir}/mini-j2ee.jar ."/>      			   
		</manifest>
		</jar>		
	</target>

	<target name="build_plugin_jars" depends="build_simpleconsole_jar, build_averageprice_jar"/>		
	

	<target name="build_jars" depends="build_plugin_jars, build_salomon_jar"/>

	
	<target name="copy_data_base">
		<mkdir dir="${release_dir}/${db_dir}"/>			
		<copy 	file="${db_dir}/${db_file}"
			todir="${release_dir}/${db_dir}"/>
	</target>

	<target name="copy_init_db">
		<mkdir dir="${release_dir}/${db_dir}"/>			
		<copy 	file="${db_dir}/${crebas_file}"
			todir="${release_dir}/${db_dir}"/>
	</target>

	<target name="copy_res">
		<mkdir dir="${release_dir}/${res_dir}"/>	
		<copy todir="${release_dir}/${res_dir}">
			<fileset dir="${basedir}/${res_dir}"/>
		</copy>	
	</target>

	<target name="copy_config">
		<mkdir dir="${release_dir}"/>	
		<copy todir="${release_dir}">
			<fileset file="*.conf" />
			<fileset file="${src_dir}/*.properties"/>
		</copy>	
	</target>	

	<target name="copy_plugins" depends="build_plugin_jars">
		<mkdir dir="${release_dir}/${plugin_dir}"/>	
		<copy 	todir="${release_dir}/${plugin_dir}">
			<fileset file="${plugin_dir}/*.jar"/>	
		</copy>
	</target>	

	<target name="copy_libs">
		<mkdir dir="${release_dir}/${lib_dir}"/>	
		<copy 	todir="${release_dir}/${lib_dir}">
			<fileset file="${lib_dir}/*.jar"/>			
		</copy>
	</target>	
	
	<target name="copy_drivers">
		<mkdir dir="${release_dir}"/>
		<copy todir="${release_dir}">
			<fileset file="*.dll"/>	
		</copy>
	</target>	
	
	<target name="copy_run_files">
		<copy file="${run_script}"
			todir="${release_dir}"/>
		<copy file="all.policy"
			todir="${release_dir}"/>
	</target>	
	
	<target name="copy_salomon" depends="build_salomon_jar">
		<mkdir dir="${release_dir}"/>	
		<copy 	file="salomon.jar"
			todir="${release_dir}"/>
	</target>

	
	
	<target name="build_rmi_stubs" >
		<rmic classname="salomon.engine.platform.remote.CentralController" base="${bin_dir}"/>
		<rmic classname="salomon.engine.platform.remote.RemoteController" base="${bin_dir}"/>
		<rmic classname="salomon.engine.platform.remote.RemoteManagerEngine" base="${bin_dir}"/>
		<rmic classname="salomon.engine.platform.remote.RemotePluginManager" base="${bin_dir}"/>
		<rmic classname="salomon.engine.platform.remote.RemoteProjectManager" base="${bin_dir}"/>
		<rmic classname="salomon.engine.platform.remote.RemoteTaskManager" base="${bin_dir}"/>
		<rmic classname="salomon.engine.platform.remote.RemoteTask" base="${bin_dir}"/>
		<rmic classname="salomon.engine.platform.remote.RemoteProject" base="${bin_dir}"/>
	</target>

	<target name="all" depends="copy_salomon, copy_plugins, 
								copy_libs, copy_drivers, copy_data_base, copy_init_db, 
								copy_res, copy_config, copy_run_files"/>

	<target name="compress" depends="all">			
 		<zip destfile="salomon.zip"
		basedir="${release_dir}"
		/>
	</target>

	<target name="clean">
		<delete dir="${bin_dir}" />		
	</target>	
	
	<!-- creating installtor file -->
	<target name="installator" depends="all">
		<izpack input="${basedir}/install/install.xml"
			output="${basedir}/install.jar"
			installerType="standard"
			basedir="${basedir}/install"
			izPackDir="${izpackdir}/"/>
	</target>
	<target name="get_version">
		<svn>
			<status 
				path="${basedir}"
				revisionProperty="testStatus.revision"/>
			
		</svn>
		<echo message="REVISION_VERSION=${testStatus.revision}" file="version.properties"/>
	</target>
</project>
