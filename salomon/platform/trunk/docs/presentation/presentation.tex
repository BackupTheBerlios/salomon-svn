
\documentclass{beamer}

\usepackage[polish]{babel}
\usepackage[Cp1250]{inputenc}
\usepackage[OT4]{fontenc}
\usepackage{beamerthemeshadow}
\usepackage{fancyvrb}
\usepackage{graphicx}
\usepackage{url}

\beamertemplateballitem
\beamertemplatenumberedballsectiontoc
\setbeamertemplate{footline}[frame number]
%\setbeamertemplate{background canvas}[vertical shading][top=blue!10,bottom=white]

\hypersetup{%
  pdftitle={Wprowadzenie do Salomona},%
  pdfauthor={Salomon Team}}

\title[TP-SI: Salomon]{\small{Prezentacja programu} \emph{Salomon}}

\author{Salomon Team}

\institute{
  AGH}\date{\today}

\newcounter{minisection}
\newcommand{\minisectionframe}[1]{
\frame{
	\begin{center}
	#1
	\end{center}
}}

\newcommand{\smallhref}[1]{{\footnotesize\href{#1}{\url{#1}}}}

%Wstawia przed kazdym poczatkiej subsection toc z zaznaczonym miejsce :-)
%\AtBeginSubsection[]
%{
%  \begin{frame}<beamer>
%    \frametitle{Outline}
%    \tableofcontents[currentsection,currentsubsection]
%  \end{frame}
%}

\begin{document}

\frame{\titlepage}

\section{Wstêp} % {{{

\frame{
	\frametitle{Czym jest Salomon}
\begin{definition}
A \alert{prime number}
\end{definition}%
	\begin{itemize}
		\item Platforma
		\pause
		\item Pluginy
		\pause
		\item Baza danych
	\end{itemize}
}

\frame{
	\frametitle{Mo¿liwe realizacje przechowywania danych, c.d.}

	\begin{block}{Nazwa bloku}
	Tutaj fajny przyklad bloku
	\end{block}
	\pause
	\begin{block}{Drugi blok}
	Czadowe to jest :-)
	\end{block}
}

% }}} end of: wstêp

\part{JDBC}

\section*{JDBC --- historia} % {{{

\frame{
	\begin{center}
	JDBC: bazy danych w Javie
	\end{center}
}

\frame{
	\frametitle{Historia JDBC}
	\begin{itemize}
		\item \emph{The JDBC API is a Java API for accessing virtually any kind
		of tabular data.}
		\pause
			\begin{itemize}
				\item kolumny
				\item wiersze
				\item dane o dostêpie sekwencyjnym
			\end{itemize}
		\pause
		\item Dlaczego nowe API a nie np. ODBC?
			\begin{itemize}
				\item OO design
				\item ,,Pure Java''
				\item wojna œwiatów\ldots{}
			\end{itemize}
	\end{itemize}
}

\frame{
	\frametitle{Historia JDBC, c.d. }
	\begin{itemize}
		\item JDBC 1.0: API pierwszej specyfikacji bardzo proste, acz funkcjonalne
		\pause
		\item JDBC 2.1 (JDK1.2): wsparcie dla standardu SQL99, dodanie
		efektywniejszych interfejsów (kursory, limity, cache)
		\pause
		\item JDBC 3.0 (JDK1.4): connection pooling, nowe formy inicjalizacji
		sterowników (JNDI)
	\end{itemize}
}

\frame{
	\frametitle{Gdzie jest JDBC?}
	\begin{itemize}
	\item Pakiety \texttt{java.sql.*}: g³ówne interfejsy i API 1.0 i czêœæ z 2.1
	\item Pakiety \texttt{javax.sql.*}: ,,optional'' API, standardowo w JDK1.4;
	aplikacje serwerowe, JDBC 3.0
	\end{itemize}
}

%\frame{
%	\frametitle{Bardzo ogólny schemat klas}
%	\includegraphics[width=\textwidth]{figures/classes.png}
%}

\section{Inicjalizowanie i nawi¹zywanie po³¹czenia}
\minisectionframe{Inicjalizowanie JDBC: sterowniki (\emph{drivers})}

\frame{
	\frametitle{Czym jest \emph{JDBC driver}?}

	Najogólniej mówi¹c, sterownik \emph{JDBC} umo¿liwia:
	
	\begin{itemize}
		\item Po³¹czenie z wybran¹ baz¹ danych (wraz z uwierzytelnianiem, jeœli
		jest ono wspierane)
		\item Wykonywanie zapytañ, oraz poleceñ bazy danych
		\item Udostêpnienie wyników zapytañ za pomoc¹ standardowego API
		zdefiniowanego w JDBC
	\end{itemize}
}

\frame{
	\frametitle{Typu sterowników JDBC}
	
	\begin{enumerate}
		\item Baza danych posiada natywny port ODBC; stosuje siê sterownik-mostek JDBC-ODBC.
		\pause
		\item Sterownik natywny (dostarczany przez producenta) z interfejsem w Javie.
		\pause
		\item Sterownik JDBC-Net; serwer poœrednicz¹cy t³umacz¹cy jeden protokó³
		w inny
		\pause
		\item Sterownik w Javie z protoko³em natywnym bazy danych
	\end{enumerate}
}

\minisectionframe{Nawi¹zywanie po³¹czenia}

\frame[containsverbatim]{
	\frametitle{Po³¹czenie z u¿yciem \texttt{DriverManager}}
	
	\begin{itemize}
		\item Klasa \texttt{DriverManager} zarz¹dzaj¹ca sterownikami
		(\texttt{Driver})
		\item \texttt{DriverManager} jest ,,singletonem'' w obrêbie JVM
		\item Auto-rejestracja sterowników przy ³adowaniu ich
		klasy do JVM (blok statyczny)
\begin{Verbatim}[fontsize=\tiny,frame=lines,label=³adowanie sterownika z kodu aplikacji]
Class.forName("pakiet.sterownika.Sterownik").newInstance();
\end{Verbatim}
		\item Dodanie klasy sterownika do property 
		\texttt{jdbc.drivers}:
\begin{Verbatim}[fontsize=\tiny,frame=lines,label=³adowanie sterownika przez property]
jdbc.drivers=pakiet.sterownika.Sterownik:drugi.sterownik.MySterownik
\end{Verbatim}
	\end{itemize}
}

\frame{
	\frametitle{Po³¹czenie z u¿yciem \texttt{DriverManager}, c.d.}
	
	\begin{itemize}
		\item Po³¹czenie z baz¹ danych (\texttt{Connection}) otrzymuje siê 
		poprzez wywo³anie metody \texttt{getConnection(url, ...)} na klasie
		\texttt{DriverManager}
		\item \texttt{DriverManager} poszukuje odpowiedniego sterownika po nazwie
		\item Format URLa s³u¿¹cego do po³¹czenia:

	\begin{math}
	\underbrace{\texttt{\scriptsize jdbc:}}_{\textrm{\tiny sta³e}}%
	\underbrace{\texttt{\scriptsize driver-protocol:}}_{\textrm{\tiny sterownik}}%
	\underbrace{\texttt{\scriptsize data-source}}_{\textrm{\tiny Ÿród³o danych}}%
	\end{math}
	
		\item Przyk³ad URLa od sterownika MySQL:

	\begin{math}
	\underbrace{\texttt{\scriptsize jdbc:}}_{\textrm{\tiny const}}%
	\underbrace{\texttt{\scriptsize mysql:}}_{\textrm{\tiny mysql}}%
	\underbrace{\texttt{\scriptsize //localhost}}_{\textrm{\tiny host}}%
	\underbrace{\texttt{\scriptsize /test-db}}_{\textrm{\tiny database}}%
	\underbrace{\texttt{\scriptsize ?autoReconnect=true}}_{\textrm{\tiny parameters}}%
	\end{math}
		
	\end{itemize}
}

\frame[containsverbatim]{
	\frametitle{Po³¹czenie z u¿yciem \texttt{DriverManager}, c.d.}
	
\begin{Verbatim}[fontsize=\tiny,frame=lines,label=uzyskiwanie po³¹czenia z kodu aplikacji]
Class.forName("pakiet.sterownika.Sterownik").newInstance();
Connection con = DriverManager.getConnection("jdbc:mysql:localhost", "user", "pwd");
\end{Verbatim}

}

\frame{
	\frametitle{Po³¹czenie z u¿yciem \texttt{DataSource}}
	
	\begin{block}{Dlaczego \texttt{DataSource} a nie \texttt{DriverManager}?}
	\begin{itemize}
	\item Aby rozdzieliæ inicjalizowanie i konfigurowanie po³¹czenia,
	od jego wykorzystania w aplikacji.
	\item Aby zapewniæ ,,transparentny'' connection pooling
	\end{itemize}
	\end{block}
}

\frame[containsverbatim]{
	
	\begin{itemize}
	\item Administrator, lub kod inicjalizuj¹cy aplikacjê: \\
		{\footnotesize
		Umieszcza specyficzn¹ implementacjê (obiekt) klasy \texttt{DataSource}
		w pewnej ga³êzi drzewa JNDI. Zazwyczaj robi siê to przez konfiguracjê
		œrodowiska (np. w pliku \texttt{servlet.xml} Tomcata), ale mo¿na
		i programowo.
		}
	\item Kod aplikacji: \\
		{\footnotesize
		Pobiera ju¿ skonfigurowany obiekt \texttt{DataSource} z ga³êzi JNDI i
		wykorzystuje go:
\begin{Verbatim}[fontsize=\tiny,frame=lines,label=Pobranie obiektu DataSource z JNDI]
Context ctx = new InitialContext();
DataSource ds = (DataSource) ctx.lookup("java:comp/env/jdbc/TestDB");
if (ds == null)
	throw new RuntimeException("DataSource not found.");
Connection conn = ds.getConnection();
\end{Verbatim}
		}
	\end{itemize}
}

\subsection{Po³¹czenia i transakcje}
\minisectionframe{Po³¹czenia i transakcje}

\frame{
	\begin{itemize}
		\item Domyœlnie, obiekty \texttt{Connection} s¹ w trybie
		\emph{auto-commit}.\\
		$\rightarrow$ Ka¿dy wykonany \texttt{Statement} jest od razu widoczny w
		bazie
		\item Zmiana domyœlnego zachowania: \texttt{con.setAutoCommit(false)} \\
		$\rightarrow$ Metody \texttt{commit()} albo
		\texttt{rollback()} na po³¹czeniu
	\end{itemize}
	
	\pause
	\begin{block}{O transakcjach}
	\begin{itemize}
		\item W ogólnoœci, wsparcie dla transakcji zale¿y od DBMS, a nie od JDBC. Nale¿y
	dok³adnie zapoznaæ siê z dokumentacj¹ DBMS i sterownika JDBC.
		\pause
		\item Transakcje rozproszone (przy u¿yciu JTA) stanowi¹ oddzielny
		temat\ldots{}
	\end{itemize}
	\end{block}
}

\section{Wysy³anie poleceñ do bazy danych}
\minisectionframe{Wysy³anie poleceñ do bazy danych}

\subsection{Zapytania proste (Statement)}
\minisectionframe{Zapytania proste (\texttt{Statement})}

\frame[containsverbatim]{
	\frametitle{Zapytania typu \emph{update} i DDL}

	\begin{itemize}
		\item Zapytania nie zwracaj¹ce wyniku;
				\texttt{INSERT},
				\texttt{UPDATE}, 
				\texttt{DELETE},
				polecenia DDE.
		\item Po utworzeniu obiektu \texttt{Statement} wywo³ujemy metodê
			\texttt{executeUpdate(String sql)}
	\end{itemize}

\begin{Verbatim}[fontsize=\tiny,frame=lines,label=Przyk³ad zapytania prostego z poleceniem DDE]
Statement st = null;
st = connection.createStatement();
st.executeUpdate("DROP TABLE sample");
int deleted = st.executeUpdate("DELETE FROM tabela WHERE id > 20");
st.close();
\end{Verbatim}
}

\frame{
	\frametitle{Zapytania typu \emph{select}}
	\begin{itemize}
		\item Zapytania zwracaj¹ce wynik (\texttt{SELECT}).
		\item Wynik jest obiektem typu \texttt{ResultSet}
		\begin{itemize}
			\item Pierwotnie \texttt{ResultSet} musia³ byæ skanowany sekwencyjnie
			(iterator), od lewej do prawej kolumny
			\item Nowsze wersje JDBC API znosz¹ te ograniczenia
			\item Pobranie wartoœci z kolumny za pomoc¹ metod konwertuj¹cych
			dane do typów Javy
		\end{itemize}
	\end{itemize}
}

%\frame[plain]{
%	\includegraphics[height=8cm]{figures/table6-1.png} \\
%	Gettery konwertuj¹ce typy JDBC to typów Javy
%	\\source: \smallhref{http://java.sun.com/j2se/1.4.2/docs/guide/jdbc/getstart/}
%}

%\frame[plain]{
%	\includegraphics[height=8cm]{figures/table9-5.png} \\
%	Automatyczna konwersja przy wywo³aniu \texttt{set/getObject()}
%	\\source: \smallhref{http://java.sun.com/j2se/1.4.2/docs/guide/jdbc/getstart/}
%}

\frame[containsverbatim]{
\begin{Verbatim}[fontsize=\tiny,frame=lines,label=Przyk³ad zapytania prostego z poleceniem SELECT]
st = con.createStatement();
ResultSet rs = st.executeQuery("SELECT * FROM sample ORDER BY cena");

ResultSetMetaData meta   = rs.getMetaData();
int columns = meta.getColumnCount();
for (int i=1;i<=columns;i++) {
	System.out.print( meta.getColumnLabel(i) + "," );
}
System.out.println();

while (rs.next()) {
	for (int i=1;i<=columns;i++) {
		System.out.print( rs.getObject(i) + "," );
	}
	System.out.println();
}
\end{Verbatim}
}


\subsection{Zapytania prekompilowane}
\minisectionframe{Zapytania prekompilowane}

\frame{
    Zapytania prekompilowane (\texttt{PreparedStatement}) stosuje siê, aby:

	\begin{itemize}
		\item Zwiêkszyæ szybkoœæ wykonywania zapytania (preprocessing)
		\item Dodaæ ,,zmienne'' w zapytaniu, oznaczane znakiem ,,\texttt{?}''
	\end{itemize}
}

\frame[containsverbatim]{
\begin{Verbatim}[fontsize=\tiny,frame=lines,label=Przyk³ad zapytania prekompilowanego z parametrami]
PreparedStatement pst = null;

pst = con.prepareStatement("SELECT * FROM sample WHERE cena < ? ORDER BY cena");
pst.setInt(1, 600);
ResultSet rs = pst.executeQuery();
// do something with rs

pst.setInt(1, 2000);
rs = pst.executeQuery();
dump(rs);
// do something with rs
\end{Verbatim}
}

\subsection{JDBC a warianty jêzyka SQL}
\minisectionframe{JDBC a warianty jêzyka SQL}

\frame{
	\begin{block}{Quote\ldots{}}
	,,SQL is the standard language for accessing relational databases.
	Unfortunately, SQL is not as standard as one would like.''
	\end{block}
}

\frame{
	\begin{itemize}
		\item Polecenia DDL zazwyczaj specyficzne dla konkretnej bazy danych
		\item Typy danych w \texttt{java.sql.Types} zwykle ,,t³umaczone'' przez sterownik
		do konkretnego DBMS
		\item \emph{SQL escape syntax} --- zamiana niektórych specjalnych znaczników 
		w locie przez sterownik; aktywacja: \texttt{Statement.setEscapeProcessing(true)} \\
		Przyk³ad: \texttt{\{d 1999-02-28\}} $\rightarrow$ \texttt{28-FEB-99}
	\end{itemize}
}

\subsection{JDBC a garbage collection}
\minisectionframe{JDBC a \emph{garbage collection}}

\frame{
	\frametitle{JDBC a garbage collection}
	
	\begin{block}{Wa¿ne}
	Zasoby JDBC, a szczególnie \texttt{Connection} i \texttt{Statement} powinny byæ
	zawsze zamykane \emph{explicite} w bloku \texttt{finally}
	przy pomocy metody \texttt{close()}.
	\end{block}
	\pause
	\begin{block}{Wa¿ne}
	\texttt{ResultSet} jest zamykany automatycznie przez \texttt{Statement} w
	momencie ponownego wykonania zapytania, lub w momencie zamkniêcia
	obiektu \texttt{Statement}.
	\end{block}	
}

\frame[containsverbatim]{
\begin{Verbatim}[fontsize=\tiny,frame=lines,label=Fragment kodu wykorzystuj¹cy poprawnie zwalnianie zasobów]
Connection connection = null;
Statement statement = null;
try {
  connection = datasource.getConnection();
  statement = connection.createStatement();
  ...
} finally {
  if (statement != null)
    statement.close();
  if (connection != null)
    connection.close();
}
\end{Verbatim}
}

\section{Connection pooling}
\minisectionframe{Connection pooling}

\frame{
	\begin{itemize}
		\item Ka¿de otwarte po³¹czenie u¿ywane jest wielokrotnie a nie zamykane
		\item Technika \emph{znacznie} zwiêkszaj¹ca efektywnoœæ aplikacji
		\item Wymagana jest starannoœæ programowania (niezwolnione po³¹czenia
		nie trafiaj¹ z powrotem do puli)
	\end{itemize}
}

\frame{
	\frametitle{Connection pool --- implementowaæ, czy wzi¹æ gotowe?}
	\begin{itemize}
		\item Dobra implementacja puli obiektów \textbf{nie jest trywialna}
		\item Lepiej wykorzystaæ gotowe pakiety (darmowe), specjalizowane dla JDBC 
		      i transparentne w u¿yciu (zmienia siê URL, lub
			  \texttt{DataSource})
			\begin{itemize}
				\item Jakarta Commons DBCP, \smallhref{http://jakarta.apache.org/commons/dbcp/}
				\item C3P0, \smallhref{http://sourceforge.net/projects/c3p0/}
			\end{itemize}
		\item Pule \emph{dowolnych} obiektów --- pakiet
		\smallhref{http://jakarta.apache.org/commons/pool/}
	\end{itemize}
}

\section*{Pominiête tematy z zakresu JDBC}

\frame{
	\frametitle{Pominiête tematy (ale równie wa¿ne!)}
	
	Uwaga: wyk³ad pomija du¿¹ czêœæ funkcjonalnoœci JDBC, np:
	
	\begin{itemize}
		\item Modyfikowalne \texttt{ResultSety}
		\item Procedury sk³adowane (\texttt{CallableStatement})
		\item Kursory
		\item SavePointy
		\item Pobieranie wartoœci sequencerów (autokeys)
		\item Typy wspó³bie¿noœci \texttt{ResultSetów}
		\item Testowanie wartoœci \texttt{null} 
	\end{itemize}
	
	Tematy te s¹ omówione dok³adnie w specyfikacji JDBC.
}

\part{JDBC w aplikacjach internetowych}

\section{JDBC w aplikacjach internetowych}
\minisectionframe{JDBC w aplikacjach internetowych}

\frame{
	\frametitle{Gdzie, co i jak inicjalizowaæ?}
	
	\begin{itemize}
	\item Parametry po³¹czenia: user, has³o, URL
		\begin{itemize}
			\item Parametry do serwletu --- \texttt{web.xml}
			\item Ustawienie \texttt{DataSet} w JNDI kontenera
			\item Weryfikacja parametrów w metodzie \texttt{init()},
			serwlet z ustawionym \texttt{load-on-startup}
		\end{itemize}
	\item Treœæ zapytañ SQL
		\begin{itemize}
			\item Zewnêtrzne zasoby aplikacji (resources)
			\item Pliki XML
			\item {\color{red} Obojêtnie co, byleby nie hard-coded}
		\end{itemize}
	\end{itemize}
}

\subsection{Tomcat i serwlet z DataSource pobieranym z JNDI}
\minisectionframe{Tomcat i serwlet z DataSource pobieranym z JNDI}

\frame[containsverbatim]{
	\frametitle{Krok 1. Piszemy serwlet}
\begin{Verbatim}[fontsize=\tiny,frame=lines,label=Serwlet odwo³uj¹cy siê do DataSource z JNDI]
...
	DataSource ds = (DataSource) ctx.lookup("java:comp/env/jdbc/TestDB");
	
	if (ds != null) {
		Connection conn = null;
		try {
			conn = ds.getConnection();
			if(conn != null)  {
			... do something with the connection
			}
		} finally {
			conn.close();
		}
	}
...
\end{Verbatim}
}

\frame[containsverbatim]{
	\frametitle{Krok 2. Informacja o zasobach do pliku \texttt{web.xml}}
\begin{Verbatim}[fontsize=\tiny,frame=lines,label=Fragment deskryptora aplikacji deklaruj¹cy zasoby]
...
	<servlet>
		<servlet-name>Serwlet</servlet-name>
		<servlet-class>tpsi.Solution1</servlet-class>
	</servlet>
	
	<servlet-mapping>
		<servlet-name>Serwlet</servlet-name>
		<url-pattern>/rozwiazanie</url-pattern>
	</servlet-mapping>

	<resource-ref>
	  <description>My DataBase Connection</description>
	  <res-ref-name>jdbc/TestDB</res-ref-name>
	  <res-type>javax.sql.DataSource</res-type>
	  <res-auth>Container</res-auth>
	</resource-ref>
...
\end{Verbatim}
}

\frame[containsverbatim]{
	\frametitle{Krok 3. Konfiguracja \texttt{DataSource} w Tomcacie 5.0.19}
\begin{Verbatim}[fontsize=\tiny,frame=lines,label=Fragment deklaracji kontekstu (plik server.xml)]
<Context path="/aplikacja" docBase="aplikacja" debug="5" reloadable="true">
	<Resource name="jdbc/TestDB" auth="Container" type="javax.sql.DataSource"/>
	<ResourceParams name="jdbc/TestDB">
		<parameter>
			<name>factory</name>
			<value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
		</parameter>
		
		<!-- Maximum number of dB connections in pool. -->
		<parameter>
		  <name>maxActive</name> <value>20</value>
		</parameter>
		
		<!-- Maximum number of idle dB connections to retain in pool.
			 Set to 0 for no limit. -->
		<parameter>
		  <name>maxIdle</name> <value>5</value>
		</parameter>
...	
\end{Verbatim}
}

\frame[plain,containsverbatim]{
\begin{Verbatim}[fontsize=\tiny,frame=lines,label=Fragment deklaracji kontekstu (plik server.xml), ci¹g dalszy]
		<!-- Maximum time to wait for a dB connection to become available
			 in ms, in this example 10 seconds. An Exception is thrown if
			 this timeout is exceeded.  Set to -1 to wait indefinitely.
			 -->
		<parameter>
		  <name>maxWait</name>
		  <value>10000</value>
		</parameter>
	
		<!-- MySQL dB username and password for dB connections  -->
		<parameter>
		 <name>username</name>
		 <value>sa</value>
		</parameter>

		<parameter>
		 <name>password</name>
		 <value></value>
		</parameter>
	
		<!-- Class name for mm.mysql JDBC driver -->
		<parameter>
		   <name>driverClassName</name>
		   <value>com.mysql.jdbc.Driver</value>
		</parameter>
	
		<!-- The JDBC connection url for connecting to your MySQL dB.
			 The autoReconnect=true argument to the url makes sure that the
			 mm.mysql JDBC Driver will automatically reconnect if mysqld closed the
			 connection.  mysqld by default closes idle connections after 8 hours.
			 -->
		<parameter>
		  <name>url</name>
		  <value>jdbc:mysql://localhost:3306/test?autoReconnect=true</value>
		</parameter>
	</ResourceParams>
</Context>
\end{Verbatim}
}

\frame{
	\begin{itemize}
		\item Nale¿y pamiêtaæ o skopiowaniu odpowiednich bibliotek
		do \texttt{tomcat/common/lib}
		\item Tomcat 5.0.19 ma ju¿ wszystko co potrzebne
		\item Kontekst (atrybut \texttt{docBase}) musi faktycznie wskazywaæ na
		aplikacjê --- problem z WARami
	\end{itemize}
}

\part{Data binding}
\section{Data binding}
\minisectionframe{Data binding}

\frame{
	\frametitle{Czym jest data binding?}
	\begin{itemize}
		\item Ukrycie przed programist¹ zawi³oœci serializowania obiektów do
		bazy danych lub innego medium
		\item Dostêp ,,obiektowy'' do bazy danych
	\end{itemize}
}

\frame[containsverbatim]{
	\frametitle{Przyk³ad}
\begin{Verbatim}[fontsize=\tiny,frame=lines,label=Data binding w akcji (Hibernate)]
Team team = new Team();
team.setCity("Detroit");
team.setName("Pistons");

// add a player to the team.
Player player = new Player();
player.setFirstName("Chauncey");
player.setLastName("Billups");
player.setJerseyNumber(1); 
player.setAnnualSalary(4000000f);
Set players = new HashSet();
players.add(player);
team.setPlayers(players);

// open a session and save the team
Session session = SessionFactory.openSession();
session.saveOrUpdate(team);
\end{Verbatim}
}

\frame[containsverbatim]{
	\frametitle{Przyk³ad --- jêzyki obiektowych zapytañ}
\begin{Verbatim}[fontsize=\tiny,frame=lines,label=Jêzyki obiektowych zapytañ]
// HQL, Hibernate
session.delete("from player in class example.Player where player.annualSalary > 4000000");

// OQL, Castor 
OQLQuery query = db.getOQLQuery(
		"SELECT s from "
			+ SubscriberBinding.class.getName()
			+ " s"
			+ " WHERE s.emailNotifierInfo.enabled = $1");
query.bind(true);
result = query.execute();
while (result.hasMore())
{
	SubscriberBinding subscriber = (SubscriberBinding) result.next();
}
\end{Verbatim}
}

\frame{
	\frametitle{Typy systemów data-binding}
	\begin{itemize}
		\item build-time 
		\begin{itemize}
			\item Generacja kodu, który realizuje mapping
			\item Zwykle z XML Schema lub podobnego opisu struktury danych,
			oraz ich przeniesienia na fizyczne obiekty
		\end{itemize}

		\item runtime
		\begin{itemize}
			\item Kod mapowania generowany dynamicznie jako klasy
			(\emph{dynamic bytecode generation})
			\item Bez kodu poœredniego (za pomoc¹ Java Reflection)
		\end{itemize}
	\end{itemize}
}

\frame{
	\frametitle{Systemy realizuj¹ce data binding}
	
	\begin{itemize}
		\item Hibernate (chyba najbardziej obecnie popularny)\\
		\smallhref{http://www.hibernate.org/}
		\item Castor (równie¿ niez³y) \\
		\smallhref{http://www.castor.org/}
		\item Inne, dotycz¹ce g³ównie XML:\\
		\smallhref{http://www.rpbourret.com/xml/XMLDataBinding.htm}
	\end{itemize}
}

\subsection{Przyk³ad: data binding w Hibernate}
\minisectionframe{Przyk³ad: data binding w Hibernate\\
{\tiny Na podstawie: 
\href{http://www.hibernate.org/hib_docs/reference/en/html/quickstart.html}{\url{http://www.hibernate.org/hib_docs/reference/en/html/quickstart.html}}}}

\frame{	
	\frametitle{Przygotowanie kontenera aplikacji}
	\begin{itemize}
		\item Tomcat 5.0.19
		\item Tworzymy kontekst aplikacji (\texttt{/hibernate})
		\item Kopiujemy biblioteki Hibernate do aplikacji
		\item Kopiujemy sterownik JDBC do \texttt{TOMCAT\_HOME/common/lib};
		u¿yjemy HSQLDB
	\end{itemize}
}

\frame[containsverbatim,plain]{	
	\frametitle{Przygotowanie \texttt{DataSource} w JNDI (\texttt{server.xml})}
\begin{Verbatim}[fontsize=\tiny,frame=lines,label=DataSource w JNDI do przyk³adu z Hibernate]
<Context path="/hibernate" docBase="hibernate">
    <Logger className="org.apache.catalina.logger.SystemOutLogger" />
    <Resource name="jdbc/quickstart" scope="Shareable" type="javax.sql.DataSource"/>
    <ResourceParams name="jdbc/quickstart">
        <parameter>
            <name>factory</name>
            <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
        </parameter>

        <parameter>
            <name>url</name>
            <value>jdbc:hsqldb:.</value>
        </parameter>
        <parameter>
            <name>driverClassName</name><value>org.hsqldb.jdbcDriver</value>
        </parameter>
        <parameter>
            <name>username</name><value>sa</value>
        </parameter>
        <parameter>
            <name>password</name><value></value>
        </parameter>

        <parameter>
            <name>maxWait</name><value>3000</value>
        </parameter>
        <parameter>
            <name>maxIdle</name><value>100</value>
        </parameter>
        <parameter>
            <name>maxActive</name><value>10</value>
        </parameter>
    </ResourceParams>
</Context>
\end{Verbatim}	
}

\frame[containsverbatim,plain]{	
	\frametitle{Ustawiamy zasoby w \texttt{web.xml}}
\begin{Verbatim}[fontsize=\tiny,frame=lines,label=Zasoby w pliku web.xml]
<?xml version="1.0" encoding="ISO-8859-1"?>

<!DOCTYPE web-app
    PUBLIC "-//Sun Microsystems, Inc.//DTD Web Application 2.2//EN"
    "http://java.sun.com/j2ee/dtds/web-app_2_2.dtd">

<web-app>
    <display-name>
        Hibernate: przyklad
    </display-name>

    <!-- Contexts initialization servlet. -->
    <servlet>
        <servlet-name>Serwlet</servlet-name>
        <servlet-class>Servlet</servlet-class>
        <load-on-startup>1</load-on-startup>
    </servlet>

    <servlet-mapping>
        <servlet-name>Serwlet</servlet-name>
        <url-pattern>/servlet</url-pattern>
    </servlet-mapping>

    <resource-ref>
      <description>Database Connection</description>
      <res-ref-name>jdbc/quickstart</res-ref-name>
      <res-type>javax.sql.DataSource</res-type>
      <res-auth>Container</res-auth>
    </resource-ref>
</web-app>
\end{Verbatim}	
}

\frame[containsverbatim,plain]{	
	\frametitle{Plik konfiguracji Hibernate \texttt{/WEB-INF/classes/hibernate.cfg.xml}}
\begin{Verbatim}[fontsize=\tiny,frame=lines,label=Konfiguracja Hibernate w naszej aplikacji]
<?xml version='1.0' encoding='utf-8'?>
<!DOCTYPE hibernate-configuration
    PUBLIC "-//Hibernate/Hibernate Configuration DTD//EN"
    "http://hibernate.sourceforge.net/hibernate-configuration-2.0.dtd">

<hibernate-configuration>
    <session-factory>
        <property name="connection.datasource">java:comp/env/jdbc/quickstart</property>
        <property name="show_sql">true</property>
        <property name="dialect">net.sf.hibernate.dialect.HSQLDialect</property>

        <!-- Mapping files -->
        <mapping resource="Cat.hbm.xml"/>
    </session-factory>
</hibernate-configuration>
\end{Verbatim}	
}

\frame[containsverbatim,plain]{	
	\frametitle{Plik mapowania klasy Cat do tabel \texttt{/WEB-INF/classes/Cat.hbm.xml}}
\begin{Verbatim}[fontsize=\tiny,frame=lines,label=Pamowanie klasy Cat do tabel]
<?xml version="1.0"?>
<!DOCTYPE hibernate-mapping
    PUBLIC "-//Hibernate/Hibernate Mapping DTD//EN"
    "http://hibernate.sourceforge.net/hibernate-mapping-2.0.dtd">
<hibernate-mapping>
    <class name="Cat" table="CAT">
        <!-- A 32 hex character is our surrogate key. It's automatically
            generated by Hibernate with the UUID pattern. -->
        <id name="id" type="string" unsaved-value="null" >
            <column name="CAT_ID" sql-type="char(32)" not-null="true"/>
            <generator class="uuid.hex"/>
        </id>

        <!-- A cat has to have a name, but it shouldn' be too long. -->
        <property name="name">
            <column name="NAME" length="16" not-null="true"/>
        </property>

        <property name="sex"/>
        <property name="weight"/>
    </class>
</hibernate-mapping>
\end{Verbatim}	
}

\frame[containsverbatim,plain]{	
	\frametitle{Klasa danych \texttt{Cat}}
\begin{Verbatim}[fontsize=\tiny,frame=lines,label=Klasa danych --- Cat]
public class Cat {
    private String id;
    private String name;
    private char sex;
    private float weight;

    public Cat() {
    }

    public String getId() {
        return id;
    }

    private void setId(String id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public char getSex() {
        return sex;
    }

    public void setSex(char sex) {
        this.sex = sex;
    }
...
\end{Verbatim}	
}

\frame[containsverbatim,plain]{	
	\frametitle{Serwlet wykorzystuj¹cy Hibernate --- metoda \texttt{init()}}
\begin{Verbatim}[fontsize=\tiny,frame=lines,label=Serwlet wykorzystuj¹cy Hibernate]
private final static String HIBERNATE_FACTORY = "hibernate_factory";
public void init(ServletConfig config) throws ServletException {
	super.init(config);
	try {
		// check if there is the datasource in the JNDI context
		Context ctx = new InitialContext();
		DataSource ds = (DataSource) ctx.lookup("java:comp/env/jdbc/quickstart");
		if (ds == null) throw new ServletException("No datasource in JNDI.");

		Connection connection = ds.getConnection();
		try {
		  Statement st = connection.createStatement();
		    st.executeUpdate( "CREATE TABLE cat ("
		      + "cat_id CHAR(16) PRIMARY KEY, name VARCHAR(16), sex CHAR(1), weight REAL )");
		} finally {
			if (connection != null) connection.close();
		}

		// attempt to initialize Hibernate
		synchronized (config) {
			// check if there is a factory in the context.
			if (getServletContext().getAttribute(HIBERNATE_FACTORY) == null) {
				SessionFactory sessionFactory = 
					new Configuration().configure().buildSessionFactory();
				getServletContext().setAttribute(HIBERNATE_FACTORY, sessionFactory);
			}
		}
	} catch (HibernateException e) {
		throw new ServletException("Hibernate problem.", e);
	} catch (NamingException e) {
		throw new ServletException("JNDI problem.", e);
	} catch (SQLException e) {
		throw new ServletException("Could not initialize db.", e);
	}
}
...
\end{Verbatim}	
}

\frame[containsverbatim,plain]{	
	\frametitle{Serwlet wykorzystuj¹cy Hibernate --- metoda \texttt{doGet()}}
\begin{Verbatim}[fontsize=\tiny,frame=lines,label=Serwlet wykorzystuj¹cy Hibernate]
try {
	SessionFactory sf = (SessionFactory) getServletContext().getAttribute(HIBERNATE_FACTORY);
	Session session = sf.openSession();
	try {
		// saving cat...
		Transaction tx= session.beginTransaction();
		Cat princess = new Cat();
		princess.setName("Princess: " + System.currentTimeMillis());
		princess.setSex('F');
		princess.setWeight(7.4f);
		session.save(princess);
		tx.commit();
		w.write("** New cat saved: " + princess.getId() + "\n");
		
		// now do some querying...
		tx= session.beginTransaction();
		Query query = session.createQuery("select c from Cat as c where c.sex = :sex");
		query.setCharacter("sex", 'M');
		for (Iterator it = query.iterate(); it.hasNext();) {
			Cat cat = (Cat) it.next();
			w.write("** Male Cat: " + cat.getName() + "\n");
		}
		tx.commit();
	} finally {
		session.close();
	}
} catch (HibernateException e) {
	throw new ServletException("Problems with hibernate.", e);
}
\end{Verbatim}	
}

\frame{
	\frametitle{Generowany przez Hibernate SQL\ldots{}}

	\begin{block}{HQL}
	\texttt{select c from Cat as c where c.sex = :sex}
	\end{block}
	
	\pause
	\begin{block}{SQL --- HSQLDB flavor}
	\texttt{select cat0\_.CAT\_ID as x0\_0\_ from CAT cat0\_ where (cat0\_.sex=?)}
	\end{block}
}

\frame{
	\frametitle{Inne materia³y i ³¹cza}
	
	\begin{itemize}
		\item JDBC Technology, \smallhref{http://java.sun.com/products/jdbc/}
		\item JDBC documentation, \smallhref{http://java.sun.com/j2se/1.4.2/docs/guide/jdbc/getstart/intro.html}
		\item Tomcat JNDI example, \smallhref{http://jakarta.apache.org/tomcat/tomcat-4.1-doc/printer/jndi-datasource-examples-howto.html}
		\item DBCP pool, \smallhref{http://jakarta.apache.org/commons/dbcp/}
		\item HSQLDB, \smallhref{http://hsqldb.sourceforge.net/}
	\end{itemize}	
}

\frame{
	\begin{center}
	Dziêkujê za uwagê.
	\end{center}
}

\end{document}
